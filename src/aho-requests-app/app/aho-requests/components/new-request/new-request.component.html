<div class="new-request">
  <h2 mat-dialog-title>Новая заявка</h2>
  <mat-dialog-content>
    <form [formGroup]="newRequestForm">

      <!-- Start: Категория заявки -->
      <mat-form-field class="w-100">
        <mat-select placeholder="Категория заявки"
                    [(value)]="newRequest.type"
                    (selectionChange)="onRequestTypeChange($event)">
          <mat-option *ngFor="let requestType of ahoRequestsService.getRequestTypes()"
                      [value]="requestType">
            {{ requestType.title }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <!-- End: Категория заявки -->

      <!-- Start: # Кабинета -->
      <mat-form-field class="w-100" *ngIf="newRequest.type.id !== 1">
        <input type="text"
               matInput
               placeholder="Введите № кабинета"
               formControlName="room"
               [(ngModel)]="newRequest.room"
               required>
        <mat-error *ngIf="newRequestForm.get('room').invalid">{{ getRoomErrorMessage() }}</mat-error>
      </mat-form-field>
      <!-- End: # Кабинета -->

      <!-- Start: Комментарий -->
      <!--
      <mat-form-field class="w-100 pt-2" *ngIf="newRequest.type.id !== 1">
        <textarea matInput
                  placeholder="Комментарий к заявке"
                  formControlName="comment"
                  [(ngModel)]="newRequest.description"
                  matTextareaAutosize
                  matAutosizeMinRows="1"
                  matAutosizeMaxRows="5"
                required>
        </textarea>
        <mat-error *ngIf="newRequestForm.get('room').invalid">{{ getCommentErrorMessage() }}</mat-error>
      </mat-form-field>
      -->
      <!-- End: Комментарий -->

      <!-- Start: Список канцелярских товаров -->
      <div class="mt-2">

        <mat-table [dataSource]="tasksDataSource">

          <!-- Start: Колонка наименования задачи -->
          <ng-container matColumnDef="title">
            <mat-header-cell *matHeaderCellDef class="office-stuff-item-title-column pr-3"> {{ newRequest.type.listTitle ? newRequest.type.listTitle : 'Перечень задач' }} </mat-header-cell>
            <mat-cell *matCellDef="let task; let i = index;" class="office-stuff-item-title-column pr-3">
              <mat-form-field class="w-100" [floatLabel]="'never'">
                <input type="text"
                       matInput
                       placeholder="{{ newRequest.type.itemTitle ? newRequest.type.itemTitle : 'Введите наименование' }}"
                       formControlName="{{ 'taskTitle' + task.timeAdded.toString() }}"
                       [(ngModel)]="task.content"
                       [matAutocomplete]="content"
                       required>
                <mat-autocomplete #content="matAutocomplete" [displayWith]="displayTaskContentTitle">
                  <mat-option *ngFor="let item of ahoRequestsService.getRequestTasksContent() | taskContentByRequestType : newRequest.type.id" [value]="item">
                    {{ item.title }}
                  </mat-option>
                </mat-autocomplete>
                <!--<mat-error *ngIf="newRequestForm.get('room').invalid">{{ getRoomErrorMessage() }}</mat-error>-->
              </mat-form-field>
            </mat-cell>
          </ng-container>
          <!-- End: Колонка наименования задачи -->

          <!-- Start: Колонка количественного измерения задачи -->
          <ng-container matColumnDef="count" *ngIf="newRequest.type.isCountable">
            <mat-header-cell *matHeaderCellDef class="office-stuff-item-count-column"> Количество </mat-header-cell>
            <mat-cell *matCellDef="let task; let i = index;" class="office-stuff-item-count-column">
              <mat-form-field class="w-100" [floatLabel]="'never'">
                <input type="number"
                       matInput
                       [min]="1"
                       placeholder="Кол-во"
                       formControlName="{{ 'taskCount' + task.timeAdded.toString() }}"
                       [(ngModel)]="task.count"
                       required>
                <mat-hint align="end">{{ task.content && task.content.boxing ? task.content.boxing : null }}</mat-hint>
              </mat-form-field>
            </mat-cell>
          </ng-container>
          <!-- End: Колонка количественного измерения задачи -->

          <!-- Start: Колонка элементов управления-->
          <ng-container matColumnDef="controls">
            <mat-header-cell *matHeaderCellDef class="office-stuff-item-controls-column"></mat-header-cell>
            <mat-cell *matCellDef="let task; let i = index; let isLast = last;" class="office-stuff-item-controls-column d-flex justify-content-end">
              <button mat-icon-button
                      [color]="'primary'"
                      [disabled]="newRequest.type.isCountable ? (newRequestForm.get('taskTitle' + task.timeAdded.toString()).invalid) : newRequestForm.get('taskTitle'  + task.timeAdded.toString()).invalid"
                      (click)="addTask()"
                      *ngIf="isLast">
                <mat-icon fontSet="fa"
                          fontIcon="fa-plus"
                          matTooltip="Добавить к заявке"
                          [matTooltipPosition]="'above'">
                </mat-icon>
              </button>

              <button mat-icon-button
                      [color]="'primary'"
                      (click)="removeTask(task)"
                      *ngIf="!isLast">
                <mat-icon fontSet="fa"
                          fontIcon="fa-trash"
                          matTooltip="Удалить из заявки"
                          [matTooltipPosition]="'above'">
                </mat-icon>
              </button>
            </mat-cell>
          </ng-container>
          <!-- End: Колонка элементов управления -->

          <mat-header-row *matHeaderRowDef="headerColumns"></mat-header-row>
          <mat-row *matRowDef="let row; let isLast = last; columns: headerColumns;" [ngClass]="{'added': !isLast}"></mat-row>
        </mat-table>

      </div>
      <!-- End: Список канцелярских товаров -->

    </form>
  </mat-dialog-content>
  <mat-dialog-actions class="pt-3">
    <div class="container-fluid p-0">
      <div class="row">

        <!-- End: Кнопка добавления заявки -->
        <div class="col-12 col-md-6">
          <button mat-raised-button
                  type="submit"
                  [color]="'primary'"
                  [disabled]="newRequest.tasks.length < 2 || ahoRequestsService.isAddingRequest()"
                  class="w-100"
                  (click)="addRequest()">
            <div class="d-flex flex-row w-100 align-items-center" *ngIf="ahoRequestsService.isAddingRequest()">
              <mat-progress-spinner
                class="mr-2"
                [diameter]="20"
                [color]="'primary'"
                [mode]="'indeterminate'">
              </mat-progress-spinner>
              Загрузка
            </div>
            <span *ngIf="!ahoRequestsService.isAddingRequest()">Подать заявку</span>
          </button>
        </div>
        <!-- End: Кнопка добавления заявки -->


        <!-- Start: Кнопка отмены -->
        <div class="col-12 col-md-6 pt-2 pt-md-0">
          <button mat-raised-button
                  mat-dialog-close
                  [color]="'warn'"
                  class="w-100">
            Отмена
          </button>
        </div>
        <!-- End: Кнопка отмены -->

      </div>
    </div>





  </mat-dialog-actions>

</div>
