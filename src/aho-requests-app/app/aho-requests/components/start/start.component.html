<div class="container-fluid no-padding content-wrapper pb-3">


  <div class="row no-gutters">
    <div class="request-list-navigation col-12 d-flex justify-content-between p-3 border-bottom">
        <div class="d-flex flex-row align-items-center">
          <!-- Start: Переход ко всем заявкам -->
          <button mat-stroked-button
                  *ngIf="authenticationService.getCurrentUser() && aho.isInEmployeeRequestsMode() && (aho.getEmployeeRequests().length > 0 || authenticationService.getCurrentUser().permissions.getRoleById(1))"
                  color="primary"
                  [disabled]="aho.isFetchingData()"
                  (click)="aho.showAllRequests()">
            &larr; &nbsp; Все заявки
          </button>
          <!-- End: Переход ко всем заявкам -->

          <!-- Start: Переход к заявкам исполнителя -->
          <button mat-stroked-button
                  color="primary"
                  *ngIf="authenticationService.getCurrentUser() && aho.getEmployeeRequestsCount() > 0 && !aho.isInEmployeeRequestsMode()"
                  [disabled]="aho.isFetchingData()"
                  (click)="showEmployeeRequests()">
            Вы назначены исполнителем
            <span class="button-badge ml-1">{{ aho.getEmployeeRequestsCount() }}</span>
          </button>
          <!-- End: Переход к заявкам исполнителя -->

          <!-- Start: Переход к просроченным заявкам -->
          <button mat-stroked-button
                  color="primary"
                  class="ml-0 ml-md-3"
                  *ngIf="authenticationService.getCurrentUser() && aho.getExpiredRequestsCount() > 0 && !aho.isInEmployeeRequestsMode()"
                  [disabled]="aho.isFetchingData()"
                  (click)="aho.showEmployeeRequests()">
            Просроченные заявки
            <span class="button-badge ml-1">{{ aho.getExpiredRequestsCount() }}</span>
          </button>
          <!-- End: Переход к просроченным заявкам -->

          <!-- Start: Переключатель показа выполненных заявок -->
          <mat-slide-toggle
            color="primary"
            class="ml-0 ml-md-3"
            labelPosition="after"
            [checked]="aho.isInShowCompletedRequestsMode()" (change)="onShowCompletedRequestsToggle($event)">
            Показывать выполненные
          </mat-slide-toggle>
          <!-- End: Переключатель показа выполненных заявок -->

          <!-- Start: Экспорт заявков а Excel -->
          <!--
          <button mat-icon-button
                  class="align-self-end"
                  color="primary"
                  (click)="exportRequests()"
                  matTooltip="Экспорт в Excel" matTooltipPosition="left">
            <mat-icon fontSet="fa" fontIcon="fa-file-excel-o" color="primary"></mat-icon>
          </button>
          -->
          <!-- End: Экспорт заявок в Excel -->
        </div>

        <div class="request-list-controls d-none d-md-flex flex-row align-items-end">
          <!-- Start: Переключатель показа выполненных заявок -->
          <!--
          <mat-slide-toggle
            color="primary"
            labelPosition="before"
            [checked]="aho.isInShowCompletedRequestsMode()" (change)="onShowCompletedRequestsToggle($event)">
            Показать выполненные
          </mat-slide-toggle>
          -->
          <!-- End: Переключатель показа выполненных заявок -->
          <button mat-icon-button [matMenuTriggerFor]="requestsListMenu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #requestsListMenu="matMenu" [yPosition]="'below'">
            <button mat-menu-item (click)="exportRequests()">
              <mat-icon color="primary">import_export</mat-icon>
              Экспорт в Excel
            </button>
          </mat-menu>
        </div>
    </div>
  </div>


  <div class="row no-gutters">
    <div class="col-12">
      <mat-table #table [dataSource]="aho.getDataSource()" class="aho-requests-table">

        <!-- Start: Request type column -->
        <ng-container matColumnDef="requestType">
          <mat-header-cell *matHeaderCellDef class="request-type-column d-none d-sm-flex"></mat-header-cell>
          <mat-cell *matCellDef="let element" class="request-type-column d-none d-sm-flex pt-2 pb-2">
            <mat-icon
              color="accent"
              fontSet="fa"
              fontIcon="{{ element.type.icon }}"
              matTooltip="{{ element.type.title }}"
              [matTooltipPosition]="'right'">
            </mat-icon>
          </mat-cell>
        </ng-container>
        <!-- End: Request type column -->

        <!-- Start: Request id column -->
        <ng-container matColumnDef="id">
          <mat-header-cell *matHeaderCellDef class="request-id-column d-none d-sm-flex"> # </mat-header-cell>
          <mat-cell *matCellDef="let element" class="request-id-column d-none d-sm-flex pt-2 pb-2"> {{ element.id }} </mat-cell>
        </ng-container>
        <!-- End: Request id column -->

        <!-- Start: Request user column -->
        <ng-container matColumnDef="user">
          <mat-header-cell *matHeaderCellDef class="request-user-column d-none d-sm-none d-md-flex ml-md-5"> Заявитель </mat-header-cell>
          <mat-cell *matCellDef="let element" class="request-user-column d-none d-sm-none d-md-flex ml-md-5 pt-2 pb-2"> {{ element.user.firstName + ' ' + element.user.lastName }} </mat-cell>
        </ng-container>
        <!-- End: Request user column -->

        <!-- Start: Request tasks column -->
        <ng-container matColumnDef="description">
          <mat-header-cell *matHeaderCellDef class="request-tasks-column"> Содержание </mat-header-cell>
          <mat-cell *matCellDef="let request" class="request-tasks-column pt-2 pb-2">
            <div *ngFor="let task of request.tasks">
              {{ task.content.title }} <span class="task-count text-muted" *ngIf="request.type.isCountable">&nbsp; &mdash; &nbsp; {{task.content.boxing ? task.count  + ' ' + task.content.boxing : task.count  + ' штук' }}</span>
            </div>
          </mat-cell>
        </ng-container>
        <!-- End: Request tasks column -->

        <!-- Start: Request date expires column -->
        <ng-container matColumnDef="dateExpires">
          <mat-header-cell *matHeaderCellDef class="request-expires-column"> Срок исполнения </mat-header-cell>
          <mat-cell *matCellDef="let element" class="request-expires-column pt-2 pb-2">
            <div class="d-flex flex-row align-items-center">
              <span class="mr-2">{{ element.dateExpires ? (element.dateExpires | date:'dd.MM.yyyy') : '' }}</span>
              <mat-icon *ngIf="element.isExpired" class="expired" matTooltip="Заявка просрочена" matTooltipPosition="below">error_outline</mat-icon>
            </div>
          </mat-cell>
        </ng-container>
        <!-- End: Request date expires column -->

        <!-- Start: Request room column -->
        <ng-container matColumnDef="room">
          <mat-header-cell *matHeaderCellDef class="request-room-column"> Кабинет </mat-header-cell>
          <mat-cell *matCellDef="let element" class="request-room-column pt-2 pb-2">{{ element.room !== '' ? element.room : '' }}</mat-cell>
        </ng-container>
        <!-- End: Request room column -->

        <!-- Start: Request date column -->
        <ng-container matColumnDef="dateCreated">
          <mat-header-cell *matHeaderCellDef class="request-date-created-column d-none d-sm-none d-md-flex"> Дата подачи заявки </mat-header-cell>
          <mat-cell *matCellDef="let element" class="request-date-created-column d-none d-sm-none d-md-flex pt-2 pb-2"> {{ element.dateCreated | date:'dd.MM.yyyy, HH:mm' }} </mat-cell>
        </ng-container>
        <!-- End: Request end column -->

        <!-- Start: Request employee column -->
        <ng-container matColumnDef="employee">
          <mat-header-cell *matHeaderCellDef class="request-employee-column d-none d-sm-none d-md-flex"> Исполнитель </mat-header-cell>
          <mat-cell *matCellDef="let element" class="request-employee-column d-none d-sm-none flex-column d-md-flex pt-2 pb-2">
            <span class="no-employee text-muted" *ngIf="element.employees.length === 0">Не назначен</span>
            <div *ngFor="let employee of element.employees">{{ employee.firstName + ' ' + employee.lastName }}</div>
          </mat-cell>
        </ng-container>
        <!-- End: Request employee column -->

        <!-- Start: Request status column -->
        <ng-container matColumnDef="requestStatus">
          <mat-header-cell *matHeaderCellDef class="request-status-column d-none d-sm-none d-md-flex"> Статус </mat-header-cell>
          <mat-cell *matCellDef="let element" class="request-status-column d-none d-sm-none d-md-flex justify-content-center pt-2 pb-2">
            <mat-icon fontSet="fa"
                      fontIcon="{{ element.status.icon }}"
                      [style.color]="element.status.iconColor ? element.status.iconColor : 'black'"
                      *ngIf="element.status.icon"
                      matTooltip="{{element.status.id !== 4 ? element.status.title : element.status.title + ' (' + element.rejectReason.content + ')'}}"
                      [matTooltipPosition]="'left'">
            </mat-icon>
          </mat-cell>
        </ng-container>
        <!-- End: Request status column -->

        <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: displayedColumns; let i = index;" (click)="selectRequest(row)"></mat-row>
      </mat-table>
    </div>
  </div>

  <!-- Start: Загрузка следующей страницы заявок -->
  <div class="row" *ngIf="!aho.getPagination().isOnTheLastPage()">
    <div class="col-12 d-flex justify-content-center align-items-center pt-3">
      <button mat-stroked-button class="col-12 col-sm-auto pt-2 pb-2 pl-3 pr-3" color="primary" [disabled]="aho.isFetchingData()" (click)="loadNextPage()">
        <div class="d-flex justify-content-center align-items-center">
          <mat-icon class="mr-2">refresh</mat-icon>
          <span>Загрузить еще</span>
        </div>
      </button>
    </div>
  </div>
  <!-- End: Загрузка следующей страницы заявок -->
</div>


<button mat-fab
        [color]="'primary'"
        id="add-request-button"
        (click)="openNewRequestDialog()"
        *ngIf="authenticationService.getCurrentUser()"
        matTooltip="Подать заявку"
        [matTooltipPosition]="'left'">
  <mat-icon fontSet="fa" fontIcon="fa-plus"></mat-icon>
</button>
